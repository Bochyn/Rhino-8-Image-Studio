# 2026-01-13 - Sisyphus Work Journal

## [15:54:00] UI Restructure: Model-Based Controls & Session→Project Rename

### Action
Implemented major UI restructure as per user requirements:

1. **Renamed "Session" to "Project" across entire codebase**
   - Backend: Session model → Project, API routes `/sessions/*` → `/projects/*`
   - Shared: SessionDto → ProjectDto, CreateSessionRequest → CreateProjectRequest
   - Frontend: All types, API calls, components updated

2. **HomePage with tabs**
   - "My Projects" tab showing project cards
   - "Generations" tab with global generations history
   - Added `/api/generations` endpoint for global generations list

3. **Simplified SourcesPanel**
   - Removed width/height/AR controls (now model-dependent)
   - Only shows Viewport Capture button + DisplayMode selector
   - Fixed 1024x1024 capture resolution

4. **Model-based ControlsPanel**
   - Created `src/lib/models.ts` with all model configs
   - Each mode now shows the assigned model (nano-banana, qwen, topaz)
   - Mode → Model mapping:
     - Generate: `fal-ai/nano-banana/edit`
     - Refine: `fal-ai/nano-banana/edit`
     - Multi-Angle: `fal-ai/qwen-image-edit-2511-multiple-angles`
     - Upscale: `fal-ai/topaz/upscale/image`

5. **Rewrote settings components**
   - `GenerationSettings`: aspect_ratio, num_images (1-4), output_format
   - `MultiAngleSettings`: horizontal_angle (0-360), vertical_angle (-30-90), zoom (0-10), lora_scale
   - `UpscaleSettings`: Topaz model selection, upscale_factor (1-4), face_enhancement, output_format

6. **Backend updates**
   - Updated `FalModels` constants with correct model IDs
   - Updated `MultiAngleRequest` with new parameter names
   - Updated `UpscaleRequest` for Topaz API (model type, face_enhancement)
   - Updated `JobProcessor` to handle new APIs

### Files Touched

**Backend:**
- `src/RhinoImageStudio.Backend/Program.cs`
- `src/RhinoImageStudio.Backend/Data/AppDbContext.cs`
- `src/RhinoImageStudio.Backend/Services/JobProcessor.cs`
- `src/RhinoImageStudio.Backend/Services/EventBroadcaster.cs`

**Shared:**
- `src/RhinoImageStudio.Shared/Models/Models.cs`
- `src/RhinoImageStudio.Shared/Contracts/Contracts.cs`
- `src/RhinoImageStudio.Shared/Constants/Constants.cs`

**Frontend:**
- `src/RhinoImageStudio.UI/src/lib/types.ts`
- `src/RhinoImageStudio.UI/src/lib/api.ts`
- `src/RhinoImageStudio.UI/src/lib/sse.ts`
- `src/RhinoImageStudio.UI/src/lib/models.ts` (NEW)
- `src/RhinoImageStudio.UI/src/App.tsx`
- `src/RhinoImageStudio.UI/src/pages/HomePage.tsx`
- `src/RhinoImageStudio.UI/src/pages/StudioPage.tsx`
- `src/RhinoImageStudio.UI/src/hooks/useSession.ts`
- `src/RhinoImageStudio.UI/src/hooks/useJobs.ts`
- `src/RhinoImageStudio.UI/src/components/Studio/ControlsPanel.tsx`
- `src/RhinoImageStudio.UI/src/components/Studio/SourcesPanel.tsx`
- `src/RhinoImageStudio.UI/src/components/Controls/CaptureSettings.tsx`
- `src/RhinoImageStudio.UI/src/components/Controls/GenerationSettings.tsx`
- `src/RhinoImageStudio.UI/src/components/Controls/MultiAngleSettings.tsx`
- `src/RhinoImageStudio.UI/src/components/Controls/UpscaleSettings.tsx`
- `src/RhinoImageStudio.UI/src/components/Sessions/SessionCard.tsx`
- `src/RhinoImageStudio.UI/src/components/Sessions/CreateSessionModal.tsx`

### Tools Used
- Direct file editing
- dotnet build
- npm run build
- LSP diagnostics

### Status
Success - Both C# solution and React UI build without errors.

---

## [15:55:00] Database Schema Fix

### Issue
After Session→Project rename, the SQLite database still had `Sessions` table while code expected `Projects` table.

**Error:** `SQLite Error 1: 'no such table: Projects'`

### Fix
Deleted old database file at `C:\Users\mateu\AppData\Local\RhinoImageStudio\rhinoimagestudio.db`.

On backend restart, EF Core's `EnsureCreated()` creates fresh database with correct schema.

### Status
Fixed

---

## [15:56:00] Capture Upload Fix

### Issue
Viewport capture was failing with `BadRequest` error.

**Root cause:** `RhinoBridge.cs` was sending form field `sessionId` but backend expected `projectId`.

### Fix
Updated `src/RhinoImageStudio.Plugin/RhinoBridge.cs` line 80:
```csharp
// Before
content.Add(new StringContent(sessionId), "sessionId");

// After  
content.Add(new StringContent(sessionId), "projectId");
```

### Status
Fixed - Capture now works correctly.

---

## [15:57:00] Settings Modal for API Key

### Issue
No UI to configure fal.ai API key.

### Fix
1. Added config API methods to `src/lib/api.ts`
2. Created `src/components/Settings/SettingsModal.tsx`
3. Updated `StudioPage.tsx` - Settings button now opens modal
4. Modal shows API key status and allows setting new key

### Status
Complete - Users can now set API key via Settings gear icon.

---

## Summary

All requested features implemented and verified:
- Session → Project rename complete
- HomePage with My Projects / Generations tabs
- Simplified SourcesPanel (DisplayMode only)
- Model-based ControlsPanel with dynamic settings
- Database schema fixed
- Capture upload fixed
- Settings modal for API key added

*Signed: Sisyphus*
